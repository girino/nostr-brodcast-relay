version: '3.8'

services:
  relay:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: broadcast-relay
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Relay configuration
      - RELAY_PORT=${RELAY_PORT:-3334}
      - SEED_RELAYS=${SEED_RELAYS:-wss://relay.damus.io,wss://nos.lol,wss://relay.nostr.band}
      - MANDATORY_RELAYS=${MANDATORY_RELAYS:-}
      - TOP_N_RELAYS=${TOP_N_RELAYS:-50}
      # Health and refresh intervals
      - REFRESH_INTERVAL=${REFRESH_INTERVAL:-24h}
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-5m}
      - INITIAL_TIMEOUT=${INITIAL_TIMEOUT:-5s}
      # Performance tuning
      - SUCCESS_RATE_DECAY=${SUCCESS_RATE_DECAY:-0.95}
      # Worker configuration (0 = auto: 2*CPU)
      - WORKER_COUNT=${WORKER_COUNT:-0}
      # Cache configuration
      - CACHE_TTL=${CACHE_TTL:-5m}
      # Logging
      - VERBOSE=${VERBOSE:-}
      # Relay metadata (NIP-11 and main page)
      - RELAY_NAME=${RELAY_NAME:-Broadcast Relay}
      - RELAY_DESCRIPTION=${RELAY_DESCRIPTION:-A Nostr relay that broadcasts events to multiple relays}
      - RELAY_URL=${RELAY_URL:-}
      - CONTACT_PUBKEY=${CONTACT_PUBKEY:-}
      - RELAY_PRIVKEY=${RELAY_PRIVKEY:-}
      - RELAY_ICON=${RELAY_ICON:-/static/icon1.png}
      - RELAY_BANNERS=${RELAY_BANNERS:-}
      # Rate limiting (tokens,interval,max; use "0,0,0" or "off" to disable)
      - RATE_LIMIT_CONNECTION=${RATE_LIMIT_CONNECTION:-1,5m,100}
      - RATE_LIMIT_EVENT_IP=${RATE_LIMIT_EVENT_IP:-2,3m,10}
      - RATE_LIMIT_FILTER_IP=${RATE_LIMIT_FILTER_IP:-20,1m,100}
    networks:
      - relay-network
    ports:
      # Expose to host for nginx proxy
      - "127.0.0.1:3334:3334"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3334/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  tor:
    image: goldy/tor-hidden-service:latest
    container_name: broadcast-relay-tor
    restart: unless-stopped
    environment:
      # Hidden service configuration
      # Syntax: {SERVICE}_TOR_SERVICE_HOSTS=port:target:targetport
      - RELAY_TOR_SERVICE_HOSTS=80:relay:3334
      - RELAY_TOR_SERVICE_VERSION=3
      # Enable SOCKS proxy for health check
      - TOR_SOCKS_PORT=9050
    volumes:
      # Persist Tor hidden service keys
      - tor-data:/var/lib/tor/hidden_service/
    networks:
      - relay-network
    healthcheck:
      # Test Tor connectivity by checking Tor Project API
      # 1. Hidden service hostname file exists
      # 2. Test actual Tor connectivity using torsocks + wget
      test: ["CMD", "sh", "-c", "test -f /var/lib/tor/hidden_service/relay/hostname && torsocks wget -q -O - https://check.torproject.org/api/ip | grep -q '\"IsTor\":true'"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 90s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Autoheal - automatically restart unhealthy containers
  autoheal:
    image: willfarrell/autoheal:latest
    container_name: broadcast-relay-autoheal
    restart: unless-stopped
    environment:
      - AUTOHEAL_CONTAINER_LABEL=all
      - AUTOHEAL_INTERVAL=10
      - AUTOHEAL_START_PERIOD=30
      - AUTOHEAL_DEFAULT_STOP_TIMEOUT=10
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - relay-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  relay-network:
    driver: bridge

volumes:
  tor-data:

