version: '3.8'

services:
  relay:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: broadcast-relay
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Relay configuration
      - RELAY_PORT=3334
      - SEED_RELAYS=wss://relay.damus.io,wss://nos.lol,wss://relay.nostr.band
      - MANDATORY_RELAYS=${MANDATORY_RELAYS:-}
      - TOP_N_RELAYS=${TOP_N_RELAYS:-50}
      
      # Worker configuration
      - WORKER_COUNT=${WORKER_COUNT:-0}  # 0 = auto (2*CPU)
      
      # Cache configuration
      - CACHE_TTL=${CACHE_TTL:-5m}
      
      # Health and refresh intervals
      - REFRESH_INTERVAL=${REFRESH_INTERVAL:-24h}
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-5m}
      - INITIAL_TIMEOUT=${INITIAL_TIMEOUT:-5s}
      
      # Performance tuning
      - SUCCESS_RATE_DECAY=${SUCCESS_RATE_DECAY:-0.95}
    networks:
      - relay-network
    ports:
      # Expose to host for nginx proxy
      - "127.0.0.1:3334:3334"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3334/stats"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  tor:
    build:
      context: .
      dockerfile: Dockerfile.tor
    container_name: broadcast-relay-tor
    restart: unless-stopped
    depends_on:
      relay:
        condition: service_healthy
    volumes:
      # Persist Tor hidden service keys
      - tor-data:/var/lib/tor/hidden_service/
    networks:
      - relay-network
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /var/lib/tor/hidden_service/hostname && pgrep tor"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Autoheal - automatically restart unhealthy containers
  autoheal:
    image: willfarrell/autoheal:latest
    container_name: broadcast-relay-autoheal
    restart: unless-stopped
    environment:
      - AUTOHEAL_CONTAINER_LABEL=all
      - AUTOHEAL_INTERVAL=10
      - AUTOHEAL_START_PERIOD=30
      - AUTOHEAL_DEFAULT_STOP_TIMEOUT=10
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - relay-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  relay-network:
    driver: bridge

volumes:
  tor-data:

